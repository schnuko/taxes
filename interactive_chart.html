<html>
	<head>
    <script type="text/JavaScript" src="https://www.google.com/jsapi"></script>
    <script type="text/javascript">
    
      google.load("visualization", "1", {packages:["corechart"]});
      google.setOnLoadCallback(drawChart);
      
		  function StB_lin(progfaktor, steuersatz, grenze) {
	  		return function(zvE) {
	    		var y = (zvE - grenze) / 10000.0;
		   		return (progfaktor * y + steuersatz) * y;
	    	}
	    }
		    	
	  	function StB_konst(steuersatz, grenze) {
	  		return function(zvE) {
	   			return steuersatz * (zvE - grenze);
    		}
    	}
    	
     /**
		   * computes the taxes for an amount of brutto income 
		   * the parameters of the StB_* functions are fetched from https://www.bmf-steuerrechner.de/ekst/?
		   * @param {Number} x Brutto Income
		   * @return {Array} containing
		   */
    	function computeTaxesCurrent(x) {   	
		  	if (x < 8130) {
	    		return [0, 0];
		   	} else if (x < 13470) {
		   		return [StB_lin(933.7, 1400, 8130)(x), 0];
		   	} else if (x < 52882) {
		   		return [1014 + StB_lin(228.74, 2397, 13469)(x), 0];
	    	} else if (x < 250731) {
	    		return [1014 + 13000, StB_konst(0.42, 52881)(x)];
	    	} else {
	    		return [1014 + 13000, 83096 + StB_konst(0.45, 250730)(x)];
	    	}	    	
	    }
		  
		  /**
		   * computes the taxes for an amount of brutto income 
		   * the parameters of the StB_* functions are computed to an accuracy of 0.01â‚¬
		   * @param {Number} x Brutto Income
		   * @return {Array} containing
		   */
		  function computeTaxesGruene(x) {    	
		   	if (x < 8712) {
	    		return [0, 0];
	    	} else if (x < 13470) {
		   		return [StB_lin(1047.71, 1400, 8712)(x), 0];
		   	} else if (x < 52882) {
		   		return [903 + StB_lin(228.74, 2397, 13469)(x), 0];
		   	} else if (x < 60000) {
		   		return [903 + 13000, StB_lin(210.70, 4200, 52881)(x)];
		   	} else if (x < 80000) {
		   		return [903 + 13000, 3096 + StB_lin(100.00, 4500, 59999)(x)];
	    	} else {
	    		return [903 + 13000, 12496 + StB_konst(0.49, 79999)(x)];
	    	}	    	  	
	    }
      
      function drawChart() {

       	var data = new google.visualization.DataTable();
				var data2 = new google.visualization.DataTable();
				var dataUser = new google.visualization.DataTable();
	
				data.addColumn('number', 'Bruttoeinkommen');
				data.addColumn({type: 'string', role: 'annotation'});
				data.addColumn('number', 'Gr\u00FCne');
				data.addColumn('number', 'Aktuell');	

				data2.addColumn('number', 'Bruttoeinkommen');
				data2.addColumn({type: 'string', role: 'annotation'});
				data2.addColumn('number', 'Gr\u00FCne');
				data2.addColumn('number', 'Aktuell');	
				
				dataUser.addColumn('string', 'Vorschlag');
				dataUser.addColumn('number', 'Gr\u00FCne');
				dataUser.addColumn({type:'string', role: 'tooltip', 'p': {'html': true}});
				dataUser.addColumn('number', 'Aktuell');
				dataUser.addColumn({type:'string', role: 'tooltip', 'p': {'html': true}});

				data.addRows([
	 		 		[0, null, 0, 0],
       		[8129, null, 0, 0],
	  			[8130, null, 0, 14],
					[8711, null, 0, null],
					[8712, null, 14, null],
					[13470, null, 23.97, 23.97],
	  			[52882, null, 42, 42],
        	[60000, null, 45, null],  
	  			[80000, null, 49, null],
					[90000, null, 49, 42]
				]);

				data2.addRows([
					[90000, null, 49, 42],
	  			[250730, null, null, 42],
	 		 		[250731, null, null, 45],
					[300000, null, 49, 45]  
				]);

		    var options = {
					vAxis: {title: 'Grenzsteuersatz in %', minValue: 0}, 
					hAxis: {title: 'zu versteuerndes, j\u00E4hrliches Bruttoeinkommen in \u20AC'},
					annotations: {style: 'line'},
					interpolateNulls: true,
					legend: {position:'none'},
					chartArea: {left:'15%', width:'200%', top:'5%'},
					animation: {duration: 700, easing: 'in'},
					colors: ['green', 'blue']
				};

		    var options2 = { 
					vAxis: {minValue: 0}, 
					hAxis: {gridlines: {count: 3}, textStyle: {fontSize: 12}},
					annotations: {style: 'line'},
					interpolateNulls: true,
					legend: {textStyle: {fontSize: 12}},
					chartArea: {left:10, top:'5%'},
					animation: {duration: 700, easing: 'in'},
					colors: ['green', 'blue']
				};

		    var chart = new google.visualization.LineChart(document.getElementById('chart_div'));
		    chart.draw(data, options);

		    var chart2 = new google.visualization.LineChart(document.getElementById('chart_div2'));
		    chart2.draw(data2, options2);

				var chartUser = new google.visualization.ColumnChart(document.getElementById('chartUser_div'));
				// no visualisation right now

		    var button = document.getElementById('button');
				var txt = document.getElementById('txt');		

				button.onclick = function() {
					x = parseInt(txt.value);
					
					if (data.getNumberOfRows() > 10) {
						data.removeRow(10);
					} 
					
					if (data2.getNumberOfRows() > 4) {
						data2.removeRow(4);
					} 
					
					if (dataUser.getNumberOfRows() > 0) {
						dataUser.removeRow(0);
					}
					
					if (x < 90000) {
						data.addRow([x, 'Ich', null, null]);
						// TODO add point
					} else {
						data2.addRow([x, 'Ich', null, null]);
						// TODO add point
					}
					
					chart.draw(data, options);
					chart2.draw(data2, options2);
					drawChartUser(x);
				}
				
				function drawChartUser(x) {
					
					var taxesCurrent = computeTaxesCurrent(x);
					var taxesCurrentSummed = Math.round(taxesCurrent[0] + taxesCurrent[1]);
					var taxesCurrentAv = Math.round(taxesCurrentSummed*1000/x)/10;
					var taxesGruene = computeTaxesGruene(x);
					var taxesGrueneSummed = Math.round(taxesGruene[0] + taxesGruene[1]);
					var taxesGrueneAv = Math.round(taxesGrueneSummed*1000/x)/10;
					
					var optionsUser = {
//						isStacked: true,
						tooltip: {isHtml: true},
						chartArea: {left:'18%', top:'10%', width:'68%'},
						vAxis: {title: 'Steuerbelastung in \u20AC', minValue: 0.8 * Math.min(taxesCurrentSummed, taxesGrueneSummed)},
						animation: {duration: 700, easing: 'in'},
						colors: ['green', 'blue']
					};
					
					dataUser.addRows([
						['', taxesGrueneSummed, 
						'<div style="padding: 5px"> <b>' + taxesGrueneSummed.toString() + 
						'\u20AC </b> j&auml;hrlich entspricht einem <br>Durchschnittssteuersatz von <b>' + taxesGrueneAv.toString() + '%</b> </div>',
						taxesCurrentSummed, '<div style="padding: 5px"> <b>' + taxesCurrentSummed.toString() + 
						'\u20AC </b> j&auml;hrlich entspricht einem <br>Durchschnittssteuersatz von <b>' + taxesCurrentAv.toString() + '%</b> </div>']
					]);
				
		    	chartUser.draw(dataUser, optionsUser);
		    	
		    }
				
			}
      
    </script>
  </head>
  <body>
  
  	<p style="text-indent:50px; font-family:serif; font-weight:600; font-size:0.8em"> Die Einkommenssteuerpl&auml;ne der Gr&uuml;nen </p>
		
		<div style="width: 100%">
			<div id="chart_div" style="width: 500px; height: 40%; float:left"></div>
			<div id="chart_div2" style="width: 300px; height: 40%; float:left"></div>	
			<div style="height: 40%"></div>
		</div>
		
		<br />

		<p  style="margin-left:50px; font-family:serif; font-weight:600; font-size:0.8em">
			Was bedeutet das f&uuml;r mich? 
			<input type="button" id="button" value="Berechne"/>
			<br />
	 		(als Single mit einem zu versteuernden Bruttoeinkommen von j&auml;hrlich
			<input type="text" size="2" id="txt"/>&euro;)
		</p>
		
		<div id="chartUser_div" style="width: 600px; height: 40%; float:left"></div>		


  </body>
</html>
